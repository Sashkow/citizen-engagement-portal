{% extends "base.html" %}
{% load static %}
{% load volunteer_extras %}
{% load static notifications_tags %}

{% load notifications_tags %}

{% load leaflet_tags %}

{% block page_title %} {{page_title}} {% endblock %}




{% block jscripts %}
    <script src="{% static 'volunteer/js/profile.js' %}"></script>
    <script src="{% static 'volunteer/js/achievements.js' %}" type="text/javascript" charset="UTF-8" ></script>
    <script src="{% static 'notifications/notify.js' %}" type="text/javascript"></script>
    <script src="{% static 'volunteer/js/live-test.js' %}" type="text/javascript"></script>
    <script src="{% static 'volunteer/js/profileedit.js' %}"></script>

    {% leaflet_js %}
    {% leaflet_css %}

    <style>
        p.ribbon{
            color: {{volunteer.league.color_league_txt}};
        }

        .volunteer-name{
            color: {{volunteer.league.color_volunteer_name}};
        }

        .curr_quat{
            color: {{volunteer.league.color_menu_item}};

        }

        .curr_symbol {
            height:120%;

        }


        .item-menu{
            color: {{volunteer.league.color_menu_item}};
        }

        .current-menu-item{
            background-image:linear-gradient(
              120deg,
              {{volunteer.league.color_current_grad1}},
              {{volunteer.league.color_current_grad2}},
              {{volunteer.league.color_current_grad1}}
            );
            border-left: 1.3vh solid {{volunteer.league.color_current_border}} ;
        }

        div.current-menu-item p.item-menu{
            color: {{volunteer.league.color_current_text}}!important;

        .leaflet-container {
                height:100%!important;
                             }
        }

        .photo-user{
           width: {{volunteer.league.img_user_width}};
           right: {{volunteer.league.img_user_height}};
           height: {{volunteer.league.img_user_height_corr}};
        }

        .notif-col{
            color:{{volunteer.league.color_not_text}};
        };

    </style>

       <script type="text/javascript">


            function onEachFeature(feature, layer) {
              var props = feature.properties;
              if (!props.description){
                props.description = "Немає опису";
              }
              var content = `<img width="100" src="${props.get_events_type_url}"/><h3><a class="event-name" get_url="${props.get_event_url}">${props.name}</a></h3><p>${props.description}</p>`;
              layer.bindPopup(content);
            }


            function pointToLayer(feature, latlng) {
              var EventIcon = L.Icon.extend({
                options: {
                  // shadowUrl:    '/static/img/shadow.png',
                  iconSize:   [50, 58],
                  iconAnchor:   [30, 55],
                  popupAnchor:  [0, 0],
                  shadowSize:   [50, 58],
                  shadowAnchor: [15, 55],
                }
              });
              var event_icon = new EventIcon({iconUrl: feature.properties.get_events_type_marker_url});
              return L.marker(latlng, {icon: event_icon});
            }


            var dataurl = '{% url "event_geo_data" %}';


            window.addEventListener("map:init", function (event) {
              var map = event.detail.map;
              map.invalidateSize()
              console.log('here');
              console.log(map);
              fetch(dataurl)
                .then(function(resp) {
                  return resp.json();
                })
                .then(function(data) {
                  L.geoJSON(data, {
                    onEachFeature: onEachFeature,
                    pointToLayer: pointToLayer
                  }).addTo(map);
              });
            });

    </script>
{% endblock %}

{% block enter_button%}
            <img class="d-block d-md-none open-profile-menu" active = "1" src="{% static 'volunteer/images/menu_icon.png' %}">
{% endblock %}

{{achieve_quant|divide:league_user.quantity_achievement|to_int}}

        {% block menu_button %}
            <form action="{% url 'logout' %}">
                <button class="btn btn-enter" type="submit">вийти</button>
            </form>
        {% endblock %}

{% block container %}

<div class="wrapper">

    <nav id="sidebar" class="text-center profile-info" style="background-image:url({{volunteer.league.background_image.url}}); background-color:{{volunteer.league.background_color}}">
         {% csrf_token %}
        <div class="user-name">
            <h3 get_url="{% url 'profile_edit' %}" class="volunteer-name first-name setting-img">{{volunteer.first_name}}</h3>
            <h4 get_url="{% url 'profile_edit' %}" class="volunteer-name setting-img">{{volunteer.last_name}}</h4>

        </div>
        <div class="ribbon-div">
             <p class="ribbon ">{{ volunteer.league }}</p>
        </div>

        <div class="profile-image">
             <img class="user-league-info league-logo setting-img" get_url="{% url 'profile_edit' %}" src="{{league_user.league_image.url}}">
                {% if volunteer.photo %}
                    <img class="photo-user setting-img" get_url="{% url 'profile_edit' %}" src="{{ volunteer.photo.url }}">
                {% else %}
                    <img class="photo-user setting-img" get_url="{% url 'profile_edit' %}" src="{% static  'volunteer/images/user_profile_default.png' %}" >
                {% endif %}
             <!--{{league_user.user_frame.url}}-->
             <img class="user-league-info photo-frame" src="{{league_user.user_frame.url}}">
        </div>

        <div class="own-progress-bar">
            <div class="own-progress-league" style="width: {{achieve_quant|divide:league_user.quantity_achievement|multiply:100|to_int}}%">
                <div class="progress_state">
                    <p class="quant-ach notif-col">{{achieve_quant}}</p>
                    <img class="img_progress_state" src="{% static 'volunteer/images/current_progress_state.png' %}">
                </div>
            </div>
            <p class="text-right" style="margin-right: 0.7vh;">5</p>
        </div>
        <div class="currency-holder">

            {% for point in user_points %}
                {% if forloop.first %} <div class="row justify-content-center padding-0"> {% endif %}
                    <div class="col-auto padding-0">
                        <img class="currency-image" src="{{ point.currency.image.url }}" >
                        <p class="curr_quat">{{point.quantity}}</p>
                    </div>
                {% if forloop.counter|divisibleby:4%} </div><div class="row justify-content-center padding-0"> {%endif%}
                {% if forloop.last %}</div>{% endif %}
            {% endfor %}
        </div>



        <div class="menu-profile">

            <div class="text-left ">
                <p class="item-menu my-volonter-events">я волонтер</p>
            </div>

            <div class="text-left">
                <p class="item-menu my-org-events">я організатор</p>
            </div>


            <div class="text-left  current-menu-item">
                <p class="news item-menu " url_get = "{% url 'type_filter' %}">новини</p>
            </div>

            <div class="text-left">
                <p class="get-achievements item-menu" get_url="{% url 'achivments' %}">мої досягнення</p>
            </div>


            <div class="text-left">
                <p class="item-menu" id="open-reg-modal" post_url="{% url 'newevent' %}">організувати подію</p>
            </div>


            <div class="text-left">
                <div  class="item-menu notifications" get_url = "{% url 'notifications' %}"> сповіщення
                        <div class="notif-quant text-center notif-col" >
                            <p>{% notifications_unread %}</p>
                        </div>
                </div>
            </div>

            <div class="text-left d-block d-md-none">
                <div class="item-menu ">
                   <a  href="{% url 'logout' %}" style="color:#ffff;">вийти </a>
                </div>
            </div>

        </div>




    </nav>



        <div class="container-fluid content-container padding-0">

            <div class="padding-0"  style="background-color: #f9ffefff;
                                         background-image:url({% static 'volunteer/images/bg_plastic1.png'%}); min-height:94vh;">

                <div class="dynamic-block">
                        {% include 'events_filter.html' %}
                       {% include 'events_result.html' %}
                </div>
            </div>





        </div>

    </div>

    {% include 'modal_event_register.html' %}
    {% include 'modal_event_filter.html' %}




{% endblock %}





