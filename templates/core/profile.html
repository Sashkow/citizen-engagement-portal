{% extends "base.html" %}
{% load static %}
{% load volunteer_extras %}
{% load static notifications_tags %}

{% load notifications_tags %}

{% load leaflet_tags %}




{% block jscripts %}
    <script src="{% static 'volunteer/js/profile.js' %}"></script>
    <script src="{% static 'volunteer/js/achievements.js' %}"></script>
    <script src="{% static 'notifications/notify.js' %}" type="text/javascript"></script>
    <script src="{% static 'volunteer/js/live-test.js' %}" type="text/javascript"></script>
    <script src="{% static 'volunteer/js/profileedit.js' %}"></script>

    {% leaflet_js %}
    {% leaflet_css %}

    <style>
        p.ribbon{
            color: {{volunteer.league.color_league_txt}};
        }

        .volunteer-name{
            color: {{volunteer.league.color_volunteer_name}};
        }

        .curr_quat{
            color: {{volunteer.league.color_menu_item}};
        }


        .item-menu{
            color: {{volunteer.league.color_menu_item}};
        }

        .current-menu-item{
            background-image:linear-gradient(
              120deg,
              {{volunteer.league.color_current_grad1}},
              {{volunteer.league.color_current_grad2}},
              {{volunteer.league.color_current_grad1}}
            );
            border-left: 1.3vh solid {{volunteer.league.color_current_border}} ;
        }

        div.current-menu-item p.item-menu{
            color: {{volunteer.league.color_current_text}}!important;

        .leaflet-container {
                height:100%!important;
                             }
        }

    </style>

       <script type="text/javascript">


            function onEachFeature(feature, layer) {
              var props = feature.properties;
              if (!props.description){
                props.description = "Немає опису";
              }
              var content = `<img width="300" src="${props.get_events_type_url}"/><h3><a class="event-name" get_url="${props.get_event_url}">${props.name}</a></h3><p>${props.description}</p>`;
              layer.bindPopup(content);
            }


            function pointToLayer(feature, latlng) {
              var EventIcon = L.Icon.extend({
                options: {
                  // shadowUrl:    '/static/img/shadow.png',
                  iconSize:   [50, 58],
                  iconAnchor:   [30, 55],
                  popupAnchor:  [0, 0],
                  shadowSize:   [50, 58],
                  shadowAnchor: [15, 55],
                }
              });
              var event_icon = new EventIcon({iconUrl: feature.properties.get_events_type_marker_url});
              return L.marker(latlng, {icon: event_icon});
            }


            var dataurl = '{% url "event_geo_data" %}';


            window.addEventListener("map:init", function (event) {
              var map = event.detail.map;
              map.invalidateSize()
              console.log('here');
              console.log(map);
              fetch(dataurl)
                .then(function(resp) {
                  return resp.json();
                })
                .then(function(data) {
                  L.geoJSON(data, {
                    onEachFeature: onEachFeature,
                    pointToLayer: pointToLayer
                  }).addTo(map);
              });
            });

    </script>
{% endblock %}

{{achieve_quant|divide:league_user.quantity_achievement|to_int}}

{% block menu_button %}
    <form action="{% url 'logout' %}">
        <button class="btn btn-enter" type="submit">вийти</button>
    </form>
{% endblock %}

{% block container %}





        <div class="row align-self-center h-100">
            <div class="profile_info col-md-3 text-center align-items-center justify-content-center" style="background-image:url({{volunteer.league.background_image.url}}); background-color:{{volunteer.league.background_color}}">
                <div class="sidebar-nav-fixed affix">
                {% csrf_token %}
                <!--<h2>{{ volunteer.league }}</h2>-->
                <div class="row">
                    <div class="col-md-12">
                        <h3 class="volunteer-name first-name">{{volunteer.first_name}}</h3>
                        <h4 class="volunteer-name">{{volunteer.last_name}}</h4>

                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <h3 class="volunteer-name first-name"> </h3>
                        <h4 class="volunteer-name"> </h4>
                        <img  class="setting-img" get_url="{% url 'profile_edit' %}" src="{% static 'volunteer/images/setting.png'%}">
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <div>
                        <p class="ribbon">{{ volunteer.league }}</p>
                </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12 profile-image">
                         <div>
                             <img class="user-league-info league-logo" src="{{league_user.league_image.url}}">
                                {% if volunteer.photo %}
                                 <img class="photo-user" src="{{ volunteer.photo.url }}">
                                {% else %}
                                <img class="photo-user" src="{% static  'volunteer/images/user_profile_default.png' %}" >
                                {% endif %}
                             <!--{{league_user.user_frame.url}}-->
                             <img class="user-league-info photo-frame" src="">
                        </div>
                    </div>

                </div>


                <div class="row justify-content-center">
                    <div class="col-md-9">
                        <div class="own-progress-bar">
                            <div class="own-progress-league" style="width: {{achieve_quant|divide:league_user.quantity_achievement|multiply:100|to_int}}%">
                                <div class="progress_state">
                                    <p class="quant-ach">{{achieve_quant}}</p>
                                    <img class="img_progress_state" src="{% static 'volunteer/images/current_progress_state.png' %}">
                                </div>
                            </div>
                        <p class="text-right" style="margin-right: 0.7vh;">5</p>
                        </div>
                    </div>
                </div>



                    {% for point in user_points %}
                        {% if forloop.first %} <div class="row justify-content-md-center"> {% endif %}
                            <div class="col-md-2">
                                <img  src="{{ point.currency.image.url }}" style="height: 3vh;">
                                <p class="curr_quat">{{point.quantity}}</p>
                            </div>
                        {% if forloop.counter|divisibleby:4%} </div><div class="row justify-content-md-center"> {%endif%}
                         {% if forloop.last %}</div>{% endif %}
                    {% endfor %}



               <div class="row profile-menu-item text-left justify-content-md-center">
                    <div class="col-md-8">
                        <p class="item-menu my-events">мої добрі справи</p>
                    </div>
                </div>
                <div class="row profile-menu-item text-left justify-content-md-center d-none">
                    <div class="col-md-8">
                        <p class="my-volonter-events ">я волонтер</p>
                    </div>
                </div>
                <div class="row profile-menu-item text-left justify-content-md-center d-none">
                    <div class="col-md-8">
                        <p  class="my-org-events ">я організатор</p>
                    </div>
                </div>
                <div class="row profile-menu-item text-left justify-content-md-center current-menu-item">
                    <div class="col-md-8">
                        <p class="news item-menu " url_get = "{% url 'type_filter' %}">новини</p>
                    </div>
                </div>
                <div class="row profile-menu-item text-left justify-content-md-center">
                    <div class="col-md-8">
                        <p class="get-achievements item-menu" get_url="{% url 'achivments' %}">мої досягнення</p>
                    </div>
                </div>
                <div class="row profile-menu-item text-left justify-content-md-center">
                    <div class="col-md-8">
                        <p class="item-menu" id="open-reg-modal" post_url="{% url 'newevent' %}">організувати подію</p>
                    </div>
                </div>
                <div class="row profile-menu-item text-left justify-content-md-center">
                    <div class="col-md-8">
                        <!--<a href="{% url 'notifications' %}" <p  class="item-menu"  >сповіщення</p>-->
                        <p  class="item-menu notifications" get_url = "{% url 'notifications' %}">сповіщення {% notifications_unread %}</p>
                    </div>
                </div>

            </div>
            </div>
            <div class="col-md-9" style="background-color: #f9ffefff;
                                         background-image:url({% static 'volunteer/images/bg_plastic1.png'%});">

            <div class="dynamic-block">
                    {% include 'events_filter.html' %}
                   {% include 'events_result.html' %}
            </div>
            </div>
            </div>

        {% include 'modal_event_register.html' %}

{% endblock %}





